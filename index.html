<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- <script src="index.js"></script> -->
    <script src="data.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
        crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <div class="header"> what makes you happy? </div>

    <!-- Icons -->
    <img class="icon achievement" id="achievement" src="achievement.svg" height="40" width="40">
    <img class="icon affection" id="affection" src="affection.svg" height="40" width="40">
    <img class="icon bonding" id="bonding" src="bonding.svg" height="50" width="40">
    <img class="icon enjoy_the_moment" id="enjoy_the_moment" src="enjoy_the_moment.svg" height="35" width="35">
    <img class="icon exercise" id="exercise" src="exercise.svg" height="40" width="40">
    <img class="icon leisure" id="leisure" src="leisure.svg" height="40" width="40">
    <img class="icon nature" id="nature" src=" nature.svg" height="40" width="40">

    <div class="icon-text achievement">achievement</div>
    <div class="icon-text affection">affection</div>
    <div class="icon-text bonding">bonding</div>
    <div class="icon-text enjoy_the_moment">enjoy the moment</div>
    <div class="icon-text exercise">exercise</div>
    <div class="icon-text leisure">leisure</div>
    <div class="icon-text nature">nature</div>

    <!-- Filters -->
    <div class="filter-container">
        <h6><b>filters</b></h6>
        <div class="items">
            <div class="gender-filters">
                <div> gender </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input type="checkbox" id="filterFemale" name="filterFemale" class="custom-control-input" onclick="updateFilter()"
                        checked checked>
                    <label class="custom-control-label" for="filterFemale">female</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterMale" class="custom-control-input" type="checkbox" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterMale">male</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterOtherGender" class="custom-control-input" type="checkbox" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterOtherGender">other</label>
                </div>
            </div>

            <div class="marital-filters">
                <div>marital status</div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterSingle" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterSingle">single</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterMarried" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterMarried">married</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterOtherMarital" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterOtherMarital">other</label>
                </div>
            </div>

            <div class="parenthood-filters">
                <div>parenthood</div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterParent" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterParent">parent </label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterNotParent" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filterNotParent">not parent</label>
                </div>
            </div>

            <div class="age-filters">
                <div>age</div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter21Under" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter21Under"> 21 & under </label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter22To25" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter22To25">22-25</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter25To30" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter25To30">25-30</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter30To35" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter30To35">30-35</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter35To40" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter35To40">35-40</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter40To50" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter40To50">40-50</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter50Plus" type="checkbox" class="custom-control-input" onclick="updateFilter()"
                        checked>
                    <label class="custom-control-label" for="filter50Plus">50+</label>
                </div>

            </div>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="col-12 modal-title">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <div class="demographic-tag gender"></div>
                    <div class="demographic-tag marital"></div>
                    <div class="demographic-tag parenthood"></div>
                    <div class="demographic-tag age"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>


    <!-- Render script -->
    <script>
        const squareSize = 20; // length of a side of a square
        const strokeWidth = .5;
        const numPerRow = 40;
        const numPerCol = 30;
        const w = (squareSize + (strokeWidth * 2)) * numPerRow; // width of svg
        const h = (squareSize + (strokeWidth * 2)) * numPerCol; // height of svg
        const margin = {
            top: 5,
            right: 5,
            bottom: 5,
            left: 5,
        }
        const colorMap = {
            "achievement": "#ffdca9",
            "affection": "#fdc7d7",
            "bonding": "#fce3f0",
            "enjoy_the_moment": "#d3c7e9",
            "exercise": "#b3cde3",
            "leisure": "#beebe9",
            "nature": "#c5f1c5",
        }


        // Create the svg
        var svg = d3.select("body").append('svg')
            .attr('class', 'chart')
            .attr('width', w + margin.left + margin.right)
            .attr('height', h + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`)
            .call(render)

        // Create scale
        const scale = d3.scaleLinear()
            .domain([0, numPerRow])
            .range([0, w])

        // TOOLTIP
        // define the div for the tooltip
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)


        function render(sel) {
            d3.csv("happy_moments_small_sample.csv").then(function (data) {
                var data = data.sort((d1, d2) => (d1.predicted_category > d2.predicted_category) ? 1 : -1);
                var data = data.slice(102);
                const squares = sel.selectAll('rect')
                    .data(data, function (d) { return d.hmid; })


                squares.enter().append('rect')
                    .attr('x', (d, i) => {
                        const n = i % numPerRow;
                        return scale(n);
                    })
                    .attr('y', (d, i) => {
                        const n = Math.floor(i / numPerRow);
                        return scale(n);
                    })
                    .attr('ry', 1)
                    .attr('rx', 1)
                    .attr('width', squareSize)
                    .attr('height', squareSize)
                    .attr('stroke-width', strokeWidth)
                    .attr('stroke', 'white')
                    .on("mouseover", handleMouseOver)
                    .on("mouseout", handleMouseOut)
                    .attr("data-toggle", "modal")
                    .attr("data-target", "#myModal")
                    .transition().delay(function (d, i) { return .6 * i; })
                    .attr("class", (d) => { return d.predicted_category; });

                // squares.exit().remove()


                function handleMouseOver(d) {
                    // highlight rect 
                    d3.select(this).style("fill", function (d) { return colorMap[d.predicted_category]; });
                    d3.select(this).style("stroke", "gray");
                    d3.select(this).style("stroke-width", "1.5px");
                    // // make rect expand
                    // var width = +d3.select(this).attr("width");
                    // d3.select(this).attr("x", +d3.select(this).attr("x") - .5).attr("width", width + 1);
                    // var height = +d3.select(this).attr("height");
                    // d3.select(this).attr("y", +d3.select(this).attr("y") - .5).attr("height", height + 1);
                    // tooltip
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 1)
                    tooltip.html("&ldquo;" + d.cleaned_hm + "&rdquo;")
                        .style("left", (d3.event.pageX + 20) + "px")
                        .style("top", (d3.event.pageY - 20) + "px");
                    //data for modal
                    d3.select(this).attr("class", "info").datum(d).style("cursor", "pointer");
                }


                function handleMouseOut(d) {
                    // unhighlight color
                    d3.select(this).style("stroke", "white");
                    d3.select(this).style("stroke-width", "0px");
                    d3.select(this).style("fill", function (d) { return colorMap[d.predicted_category]; });
                    // // change size back to normal
                    // var width = +d3.select(this).attr("width");
                    // d3.select(this).attr("x", +d3.select(this).attr("x") + .5).attr("width", width - 1);
                    // var height = +d3.select(this).attr("height");
                    // d3.select(this).attr("y", +d3.select(this).attr("y") + .5).attr("height", height - 1);
                    // tooltip
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 0);
                    d3.select(this).attr("class", null)
                }
            });

            // open modal dialogue on click
            $('#myModal').on('show.bs.modal', function (d) {
                var d = d3.select(".info").data().pop();
                let modalTitle = d3.selectAll(".modal-title");
                modalTitle.html(d.predicted_category.toUpperCase().replace(/_/g, " "));
                let modalBody = d3.selectAll(".modal-body");
                modalBody.html("&ldquo;" + d.cleaned_hm + "&rdquo;");
                let modalFooter = d3.selectAll(".modal-footer");
                //tags
                let tagGender = d3.selectAll(".demographic-tag.gender")
                tagGender.html(d.gender == 'f' ? 'female' : (d.gender == 'm' ? 'male' : 'other'))
                let tagMarital = d3.selectAll(".demographic-tag.marital")
                tagMarital.html(d.marital)
                let tagParenthood = d3.selectAll(".demographic-tag.parenthood")
                tagParenthood.html(d.parenthood == 'y' ? 'parent' : 'not parent')
                let tagAge = d3.selectAll(".demographic-tag.age")
                tagAge.html('age ' + d.age.slice(0, -2))
                // modalFooter.html("Gender: " + d.value.gender + " | Marital: " + d.value.marital + " | Parenthood: " + d.value.parenthood + " | Country: " + d.value.country);
            })

        }

        // Category highlighintg
        $('.icon').on("mouseenter", function (e) {
            highlight($(this).attr('id'));
        });
        $('.icon').on("mouseleave", function (e) {
            unhighlight()
        });

        function highlight(category) {
            console.log(category)
            d3.selectAll("rect").attr("class", function (d) {
                return d.predicted_category + " " + (d.predicted_category == category ? "is-active" : "is-inactive");
            });
        }

        function unhighlight() {
            d3.selectAll("rect").attr("class", function (d) {
                return d.predicted_category + " " + "is-active";
            });
        }

        //Filters
        function updateFilter() {
            $('.custom-checkbox').css("background-color", function () {
                if ($(this).find('input[type="checkbox"]').prop("checked")) {
                    return "#eee"
                }
                else {
                    return "#bbb"
                }
            });
            $('.custom-checkbox').css("border", function () {
                if ($(this).find('input[type="checkbox"]').prop("checked")) {
                    return "solid 1px #ddd"
                }
                else {
                    return "solid 1px #aaa"
                }
            });
        }

    </script>

</body>

</html>
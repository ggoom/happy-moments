<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- <script src="index.js"></script> -->
    <script src="data.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
        crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <div class="header"> what makes you happy? </div>

    <!-- Icons -->
    <img class="icon achievement" src="achievement.svg" height="40" width="40">
    <img class="icon affection" src="affection.svg" height="40" width="40">
    <img class="icon bonding" src="bonding.svg" height="50" width="40">
    <img class="icon enjoy_the_moment" src="enjoy_the_moment.svg" height="35" width="35">
    <img class="icon exercise" src="exercise.svg" height="40" width="40">
    <img class="icon leisure" src="leisure.svg" height="40" width="40">
    <img class="icon nature" src="nature.svg" height="40" width="40">

    <div class="icon-text achievement">achievement</div>
    <div class="icon-text affection">affection</div>
    <div class="icon-text bonding">bonding</div>
    <div class="icon-text enjoy_the_moment">enjoy the moment</div>
    <div class="icon-text exercise">exercise</div>
    <div class="icon-text leisure">leisure</div>
    <div class="icon-text nature">nature</div>

    <!-- Filters -->
    <div class="filter-container">
        <h6>filters</h6>
        <div class="items">
            <div class="gender-filters"> 
                <div> gender </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterFemale" type="checkbox" onclick="render()">
                    <label for="filterFemale">female </label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterMale" type="checkbox" onclick="render()">
                    <label for="filterMale">male</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterOtherGender" type="checkbox" onclick="render()">
                    <label for="filterOtherGender">other</label>
                </div>
            </div>

            <div class="marital-filters">
                <div>marital status</div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterSingle" type="checkbox" onclick="render()">
                    <label for="filterSingle">single</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterMarried" type="checkbox" onclick="render()">
                    <label for="filterMarried">married</label>  
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterOtherMarital" type="checkbox" onclick="render()">
                    <label for="itefilterOtherMaritalm5">other</label>
                </div>
            </div>

            <div class="parenthood-filters"> 
                <div>parenthood</div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterParent" type="checkbox" onclick="render()">
                    <label for="filterParent">parent </label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filterNotParent" type="checkbox" onclick="render()">
                    <label for="filterNotParent">not parent</label>
                </div>
            </div>

            <div class="age-filters"> 
                <div>age</div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter21Under" type="checkbox" onclick="render()">
                    <label for="filter21Under"> 21 & under </label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter21To25" type="checkbox" onclick="render()">
                    <label for="filter21To25">21-25</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                        <input id="filter25To30" type="checkbox" onclick="render()">
                        <label for="filter25To30">26-30</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter30To35" type="checkbox" onclick="render()">
                    <label for="filter30To35">31-35</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter35To40" type="checkbox" onclick="render()">
                    <label for="filter35To40">36-40</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                        <input id="filter40To50" type="checkbox" onclick="render()">
                        <label for="filter40To50">41-50</label>
                </div>
                <div class="custom-control custom-checkbox custom-control-inline">
                    <input id="filter50Plus" type="checkbox" onclick="render()">
                    <label for="filter50Plus">51+</label>
                </div>

            </div>
        
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="col-12 modal-title">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <div class="demographic-tag gender"></div>
                    <div class="demographic-tag marital"></div>
                    <div class="demographic-tag parenthood"></div>
                    <div class="demographic-tag age"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    
    <!-- Render script -->
    <script>
        const squareSize = 20; // length of a side of a square
        const strokeWidth = .5;
        const numPerRow = 40;
        const numPerCol = 30;
        const w = (squareSize + (strokeWidth * 2)) * numPerRow; // width of svg
        const h = (squareSize + (strokeWidth * 2)) * numPerCol; // height of svg
        const margin = {top: 5,
                        right: 5,
                        bottom: 5,
                        left: 5,
                        }
        const colorMap = {"achievement": "#ffdca9",
                            "affection": "#fdc7d7",
                            "bonding" : "#fce3f0",
                            "enjoy_the_moment": "#d3c7e9",
                            "exercise": "#b3cde3",
                            "leisure": "#beebe9",
                            "nature": "#c5f1c5",
                            }

        // Create scale
        const scale = d3.scaleLinear()
            .domain([0, numPerRow])
            .range([0, w]);

        // TOOLTIP
        // define the div for the tooltip
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
                        
        // Create the svg
        var svg = d3.select("body").append('svg')
                    .attr('class', 'chart')
                    .attr('width', w + margin.left + margin.right)
                    .attr('height', h + margin.top + margin.bottom)
        var chart = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`)

        /**
         * Render the data into the visualization layout.
         */
        function render () {
            // Load in data
            d3.csv("happy_moments_processed_full.csv").then(function (raw_data) {
                // Filter, shuffle, slice, and sort data
                let data = filter(raw_data);
                // shuffle(data);
                if (data.length >= 1200) {
                    data = data.slice(0, 1200);
                }
                console.log(data);
                data = data.sort((d1, d2) => (d1.predicted_category > d2.predicted_category) ? 1 : -1);
                const l = data.length;

                chart.selectAll('rect').remove();
                
                // Append new squares
                const squares = chart.selectAll('rect')
                                .data(data, function(d) {return d.hmid;})
                
                squares.enter().append('rect')
                    .attr('x', (d, i) => {
                        const n = i % numPerRow;
                        return scale(n);
                    })
                    .attr('y', (d, i) => {
                        const n = Math.floor(i / numPerRow);
                        return scale(n);
                    })
                    .attr('ry', 1)
                    .attr('rx', 1)
                    .attr('width', squareSize)
                    .attr('height', squareSize)
                    .attr('stroke-width', strokeWidth)
                    .attr('stroke', 'white')
                    .on("mouseover", handleMouseOver)
                    .on("mouseout", handleMouseOut)
                    .attr("data-toggle", "modal")
                    .attr("data-target", "#myModal")
                    .transition().delay(function(d, i) {return .9 * i;})
                    .attr("class", (d) => {return d.predicted_category;});



                function handleMouseOver(d) {
                    // highlight rect 
                    d3.select(this).style("fill", function (d) {return colorMap[d.predicted_category];});
                    d3.select(this).style("stroke", "black");
                    d3.select(this).style("stroke-width", "1.5px");
                    // make rect expand
                    var width = +d3.select(this).attr("width");
                    d3.select(this).attr("x", +d3.select(this).attr("x") - .5).attr("width", width + 1);
                    var height = +d3.select(this).attr("height");
                    d3.select(this).attr("y", +d3.select(this).attr("y") - .5).attr("height", height + 1);
                    // tooltip
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 1)
                    tooltip.html("&ldquo;" + d.cleaned_hm + "&rdquo;")
                        .style("left", (d3.event.pageX + 20) + "px")
                        .style("top", (d3.event.pageY - 20) + "px");
                    //data for modal
                    d3.select(this).attr("class", "info").datum(d).style("cursor", "pointer");
                }


                function handleMouseOut(d) {
                    // unhighlight color
                    d3.select(this).style("stroke", "white");
                    d3.select(this).style("stroke-width", "1px");
                    d3.select(this).style("fill", function (d) {return colorMap[d.predicted_category];});
                    // change size back to normal
                    var width = +d3.select(this).attr("width");
                    d3.select(this).attr("x", +d3.select(this).attr("x") + .5).attr("width", width - 1);
                    var height = +d3.select(this).attr("height");
                    d3.select(this).attr("y", +d3.select(this).attr("y") + .5).attr("height", height - 1);
                    // tooltip
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 0);
                    d3.select(this).attr("class", null)
                }
            });

            // open modal dialogue on click
            $('#myModal').on('show.bs.modal', function (d) {
                var d = d3.select(".info").data().pop();
                let modalTitle = d3.selectAll(".modal-title");
                modalTitle.html(d.predicted_category.toUpperCase().replace(/_/g, " "));
                let modalBody = d3.selectAll(".modal-body");
                modalBody.html("&ldquo;" + d.cleaned_hm + "&rdquo;");
                let modalFooter = d3.selectAll(".modal-footer");
                //tags
                let tagGender = d3.selectAll(".demographic-tag.gender")
                tagGender.html(d.gender == 'f' ? 'female' : (d.gender == 'm' ? 'male' : 'other'))
                let tagMarital = d3.selectAll(".demographic-tag.marital")
                tagMarital.html(d.marital)
                let tagParenthood = d3.selectAll(".demographic-tag.parenthood")
                tagParenthood.html(d.parenthood == 'y' ? 'parent' : 'not parent')
                let tagAge = d3.selectAll(".demographic-tag.age")
                tagAge.html('age ' + d.age.slice(0, -2))
                // modalFooter.html("Gender: " + d.value.gender + " | Marital: " + d.value.marital + " | Parenthood: " + d.value.parenthood + " | Country: " + d.value.country);
            })

        }

        // Update data according to filters
        function filter(data) {
            var filter_arr = ["filterFemale", "filterMale", "filterOtherGender", 
                            "filterSingle", "filterMarried", "filterOtherMarital", 
                            "filterParent", "filterNotParent", 
                            "filter21Under", "filter22To25", "filter25To30", "filter30To35", "filter35To40", "filter40To50", "filter50Plus"];
            var filter_map = {"filterFemale": "f", "filterMale": "m", "filterOtherGender": "o", 
                            "filterSingle": "single", "filterMarried": "married", "filterOtherMarital": "other", 
                            "filterParent": "y", "filterNotParent": "n", 
                            "filter21Under": "(0, 21]", "filter22To25": "(21, 25]", "filter25To30": "(25, 30]", 
                                    "filter30To35": "(30, 35]", "filter35To40": "(35, 40]", "filter40To50": "(40, 50]", 
                                    "filter50Plus": "(50, 100]"};
            var filter_indicators = filter_arr.map(f => $(`input[type="checkbox"][id=${f}]`).prop("checked") == true );

            var gender_indices = [0, 3];
            var marital_status_indices = [3, 6];
            var parenthood_indices = [6, 8];
            var age_indices = [8, 15];

            let f_data_gender = filter_helper(data, gender_indices, 'gender');
            let f_data_marital = filter_helper(f_data_gender, marital_status_indices, 'marital');
            let f_data_parenthood = filter_helper(f_data_marital, parenthood_indices, 'parenthood');
            let f_data_age = filter_helper(f_data_parenthood, age_indices, 'age_bins');

            // Filters data for a filter category
            function filter_helper(data, indices, category) {
                var filtered_data = [];
                var filter_subset = filter_arr.slice(indices[0], indices[1]);
                var f_ind = filter_indicators.slice(indices[0], indices[1]);

                // Ignore filter category if all or none of the options are selected
                let f_ind_false = 0;
                let f_ind_true = 0;
                for (f of f_ind) {
                    if (f) {
                        f_ind_true++;
                    } else {
                        f_ind_false++;
                    }
                }
                if (f_ind_true === f_ind.length || f_ind_false === f_ind.length) {
                    return data;
                }

                // OR operation for all true filters
                for (let i=0; i < f_ind.length; i++) {
                    if (f_ind[i]) {
                        let temp_data = data.filter(function(d){return d[category] === filter_map[filter_subset[i]]});
                        filtered_data.push.apply(filtered_data, temp_data);
                    }
                }
                console.log(filtered_data.length);
                return filtered_data;
            }

            return f_data_age;
        }

        render();

        
    </script>

</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- <script src="index.js"></script> -->
    <script src="data.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
        crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Icons -->
    <img class="icon achievement" src="achievement.svg" height="40" width="40">
    <img class="icon affection" src="affection.svg" height="40" width="40">
    <img class="icon bonding" src="bonding.svg" height="50" width="40">
    <img class="icon enjoy_the_moment" src="enjoy_the_moment.svg" height="35" width="35">
    <img class="icon exercise" src="exercise.svg" height="40" width="40">
    <img class="icon leisure" src="leisure.svg" height="40" width="40">
    <img class="icon nature" src="nature.svg" height="40" width="40">

    <div class="icon-text achievement">achievement</div>
    <div class="icon-text affection">affection</div>
    <div class="icon-text bonding">bonding</div>
    <div class="icon-text enjoy_the_moment">enjoy the moment</div>
    <div class="icon-text exercise">exercise</div>
    <div class="icon-text leisure">leisure</div>
    <div class="icon-text nature">nature</div>


    <script>
        const squareSize = 20; // length of a side of a square
        const strokeWidth = .5;
        const numPerRow = 40;
        const numPerCol = 30;
        const w = (squareSize + (strokeWidth * 2)) * numPerRow; // width of svg
        const h = (squareSize + (strokeWidth * 2)) * numPerCol; // height of svg
        const margin = {top: 5,
                        right: 5,
                        bottom: 5,
                        left: 5,
                        }
        const colorMap = {"achievement": "#ffdca9",
                            "affection": "#fdc7d7",
                            "bonding" : "#fce3f0",
                            "enjoy_the_moment": "#d3c7e9",
                            "exercise": "#b3cde3",
                            "leisure": "#beebe9",
                            "nature": "#c5f1c5",
                            }

                        
        // Create the svg
        var svg = d3.select("body").append('svg')
                    .attr('class', 'chart')
                    .attr('width', w + margin.left + margin.right)
                    .attr('height', h + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`)
                    .call(render)

        // Create scale
        const scale = d3.scaleLinear()
            .domain([0, numPerRow])
            .range([0, w])

        // TOOLTIP
        // define the div for the tooltip
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)
            

        function render (sel) {
            d3.csv("happy_moments_small_sample.csv").then(function (data) {
                var data = data.sort((d1, d2) => (d1.predicted_category > d2.predicted_category) ? 1 : -1);
                var data = data.slice(102);
                const squares = sel.selectAll('rect')
                                .data(data, function(d) {return d.hmid;})


                squares.enter().append('rect')
                    .attr("class", (d) => {return d.predicted_category;})
                    .attr('x', (d, i) => {
                        const n = i % numPerRow;
                        return scale(n);
                    })
                    .attr('y', (d, i) => {
                        const n = Math.floor(i / numPerRow);
                        return scale(n);
                    })
                    .attr('ry', 1)
                    .attr('rx', 1)
                    .attr('width', squareSize)
                    .attr('height', squareSize)
                    .attr('stroke-width', strokeWidth)
                    .attr('stroke', 'white')
                    .on("mouseover", handleMouseOver)
                    .on("mouseout", handleMouseOut);

                // join.exit().remove()


                function handleMouseOver(d) {
                    // highlight rect 
                    d3.select(this).style("fill", function (d) {return colorMap[d.predicted_category];});
                    d3.select(this).style("stroke", "black");
                    d3.select(this).style("stroke-width", "1.5px");
                    // make rect expand
                    var width = +d3.select(this).attr("width");
                    d3.select(this).attr("x", +d3.select(this).attr("x") - .5).attr("width", width + 1);
                    var height = +d3.select(this).attr("height");
                    d3.select(this).attr("y", +d3.select(this).attr("y") - .5).attr("height", height + 1);
                    // tooltip
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 1)
                    tooltip.html("&ldquo;" + d.cleaned_hm + "&rdquo;")
                        .style("left", (d3.event.pageX + 20) + "px")
                        .style("top", (d3.event.pageY - 20) + "px");
                    //data for modal
                    d3.select(this).attr("class", "info").datum(d).style("cursor", "pointer");
                }


                function handleMouseOut(d) {
                    // unhighlight color
                    d3.select(this).style("stroke", "white");
                    d3.select(this).style("stroke-width", "1px");
                    d3.select(this).style("fill", function (d) {return colorMap[d.predicted_category];});
                    // change size back to normal
                    var width = +d3.select(this).attr("width");
                    d3.select(this).attr("x", +d3.select(this).attr("x") + .5).attr("width", width - 1);
                    var height = +d3.select(this).attr("height");
                    d3.select(this).attr("y", +d3.select(this).attr("y") + .5).attr("height", height - 1);
                    // tooltip
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 0);
                    d3.select(this).attr("class", null)
                }
            });
        }
        
    </script>

</body>

</html>
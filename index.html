<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div>
        <button onclick="update('achievement')">Achievement</button>
        <button onclick="update('affection')">Affection</button>
    </div>

    <script>
        // Set some variables here
        const minAge = 18;
        const maxAge = 90;
        const maxNum = 190;

        var margin = { top: 20, right: 15, bottom: 60, left: 60 }
            , width = 960 - margin.left - margin.right
            , height = 500 - margin.top - margin.bottom;

        var x = d3.scaleLinear()
            .domain([minAge, maxAge])
            .range([0, width])
        var y = d3.scaleLinear()
            .domain([0, maxNum])
            .range([height, 0]);

        var chart = d3.select('body')
            .append('svg:svg')
            .attr('width', width + margin.right + margin.left)
            .attr('height', height + margin.top + margin.bottom)
            .attr('class', 'chart')

        var main = chart.append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
            .attr('width', width)
            .attr('height', height)
            .attr('class', 'main')

        // draw the x axis
        var xAxis = d3.axisBottom(x).tickSize(0);

        main.append('g')
            .attr('transform', 'translate(0,' + height + ')')
            .attr('class', 'main axis date')
            .call(xAxis);

        // draw the y axis
        var yAxis = d3.axisLeft(y).tickSize(0);

        main.append('g')
            .attr('transform', 'translate(0,0)')
            .attr('class', 'main axis date')
            .call(yAxis);


        function update(category) {
            // Load in data from csv
            d3.csv("happy_moments_sampled_data.csv").then(function (raw_data) {
                var data = raw_data.filter(function (d) { return d.predicted_category === category; });
                const ages = d3.range(minAge, maxAge, (maxAge - minAge))

                var dataByAge = d3.nest()
                    .key(function (d) { return d.age; }).sortKeys(d3.ascending)
                    .entries(data);
                console.log(JSON.stringify(dataByAge));

                var ageCount = d3.nest()
                    .key(function (d) { return d.age; }).sortKeys(d3.ascending)
                    .rollup(function (v) { return v.length; })
                    .entries(data);
                // console.log(JSON.stringify(ageCount));

                // assign indices to data within each age
                dataByAge.forEach((e1) => e1.values.forEach((e2, j) => e2.index = j));
                // console.log(JSON.stringify(dataByAge));
                console.log(dataByAge[0])
                var g = main.append("svg:g");

                g.selectAll("year")
                    .data(dataByAge)
                    .enter().append("year")
                    .attr("x", function (d) { return x(d.key); })
                    .each(function (year, j) {
                        var thisYear = d3.select(this)
                            .selectAll('rect')
                            .data(dataByAge[j])

                        thisYear.enter().append("svg:rect")
                            .attr("x", function (d) { console.log(d); return x(d.key); })
                            .attr("y", function (d, i) { return i * 4 })
                            .attr("height", 4)
                            .attr("width", 4);
                    })

            });
        }

        // Initialize plot with category = affection
        update("affection");

    </script>
</body>

</html>